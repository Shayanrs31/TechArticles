<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Azure Service Bus â€” From First Principles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â• THEME â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="dark"] {
  --bg: #0d0f14;
  --bg2: #13161e;
  --bg3: #191d28;
  --surface: #1e2230;
  --border: #2a2f42;
  --text: #e2e6f0;
  --muted: #6b7592;
  --subtle: #252a3a;
  --accent: #38bdf8;
  --green: #4ade80;
  --orange: #fb923c;
  --purple: #a78bfa;
  --red: #f87171;
  --yellow: #facc15;
}
[data-theme="light"] {
  --bg: #f8fafc;
  --bg2: #f1f5f9;
  --bg3: #e8edf5;
  --surface: #ffffff;
  --border: #cbd5e1;
  --text: #1e293b;
  --muted: #64748b;
  --subtle: #e2e8f4;
  --accent: #0284c7;
  --green: #16a34a;
  --orange: #ea580c;
  --purple: #7c3aed;
  --red: #dc2626;
  --yellow: #ca8a04;
}

/* â•â•â•â•â•â•â•â•â•â•â• BASE â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  font-size:16px;
  line-height:1.65;
  transition:background .3s,color .3s;
  overflow-x:hidden;
}
.mono{font-family:'JetBrains Mono',monospace}

/* â•â•â•â•â•â•â•â•â•â•â• PROGRESS â•â•â•â•â•â•â•â•â•â•â• */
#prog{
  position:fixed;top:0;left:0;height:2px;width:0%;
  background:linear-gradient(90deg,var(--accent),var(--purple));
  z-index:500;transition:width .1s;
}

/* â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â• */
.topbar{
  position:fixed;top:2px;left:0;right:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:.7rem 2rem;
  background:var(--bg);
  border-bottom:1px solid var(--border);
  z-index:400;
  transition:background .3s,border-color .3s;
}
.topbar-title{
  font-family:'JetBrains Mono',monospace;
  font-size:.65rem;letter-spacing:.18em;
  color:var(--muted);text-transform:uppercase;
}
.topbar-right{display:flex;align-items:center;gap:1rem}
.stage-label{
  font-family:'JetBrains Mono',monospace;
  font-size:.65rem;color:var(--accent);letter-spacing:.1em;
}

/* â•â•â•â•â•â•â•â•â•â•â• THEME TOGGLE (light switch style) â•â•â•â•â•â•â•â•â•â•â• */
.toggle-wrap{
  display:flex;align-items:center;gap:.6rem;
  font-family:'JetBrains Mono',monospace;
  font-size:.62rem;color:var(--muted);letter-spacing:.08em;
}
.toggle-switch{
  position:relative;width:44px;height:24px;cursor:pointer;
}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{
  position:absolute;inset:0;
  background:var(--subtle);
  border:1px solid var(--border);
  border-radius:12px;
  transition:all .3s;
}
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:16px;height:16px;border-radius:50%;
  background:var(--muted);
  transition:all .3s;
  display:flex;align-items:center;justify-content:center;
  font-size:9px;
}
.toggle-switch input:checked ~ .toggle-track{
  background:var(--accent);
  border-color:var(--accent);
}
.toggle-switch input:checked ~ .toggle-thumb{
  transform:translateX(20px);
  background:white;
}

/* â•â•â•â•â•â•â•â•â•â•â• SIDE NAV â•â•â•â•â•â•â•â•â•â•â• */
.sidenav{
  position:fixed;right:1.2rem;top:50%;
  transform:translateY(-50%);
  z-index:100;display:flex;flex-direction:column;gap:5px;
}
.sidenav a{
  display:block;width:6px;height:6px;
  border-radius:50%;background:var(--border);
  transition:all .25s;cursor:pointer;text-decoration:none;
}
.sidenav a.active{background:var(--accent);transform:scale(1.7)}
.sidenav a:hover{background:var(--muted)}

/* â•â•â•â•â•â•â•â•â•â•â• STAGE LAYOUT â•â•â•â•â•â•â•â•â•â•â• */
.stage{
  min-height:100vh;
  display:flex;align-items:center;
  padding:5.5rem 2rem 3.5rem;
}
.stage-grid{
  max-width:1080px;margin:0 auto;width:100%;
  display:grid;grid-template-columns:1fr 1fr;
  gap:3.5rem;align-items:start;
}
.stage-grid.flip{direction:rtl}
.stage-grid.flip>*{direction:ltr}
.stage-grid.full{grid-template-columns:1fr;max-width:840px}

.stage-divider{
  height:1px;
  background:linear-gradient(90deg,transparent,var(--border),transparent);
  margin:0 5rem;
}

/* â•â•â•â•â•â•â•â•â•â•â• TEXT CONTENT â•â•â•â•â•â•â•â•â•â•â• */
.stg-num{
  font-family:'JetBrains Mono',monospace;
  font-size:.62rem;letter-spacing:.2em;
  color:var(--accent);text-transform:uppercase;
  margin-bottom:.55rem;opacity:.75;
}
.stage h2{
  font-size:clamp(1.55rem,2.5vw,2.1rem);
  font-weight:600;line-height:1.22;
  margin-bottom:1.1rem;letter-spacing:-.02em;
}
.narr{
  font-size:.97rem;font-weight:300;
  color:var(--muted);margin-bottom:1.4rem;
  line-height:1.85;
}
.narr strong{color:var(--text);font-weight:500}

.cards{display:flex;flex-direction:column;gap:.55rem}
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:.85rem 1.1rem;
  transition:border-color .2s,background .3s;
}
.card:hover{border-color:var(--accent)}
.card-lbl{
  font-family:'JetBrains Mono',monospace;
  font-size:.58rem;letter-spacing:.16em;text-transform:uppercase;
  margin-bottom:.28rem;
}
.lbl-why{color:var(--green)}
.lbl-mis{color:var(--orange)}
.card p{font-size:.85rem;color:var(--muted);line-height:1.6}
.card p strong{color:var(--text);font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â• VISUAL BOXES â•â•â•â•â•â•â•â•â•â•â• */
.vbox{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:1.4rem;
  transition:background .3s,border-color .3s;
  overflow:hidden;
}
.vbox-title{
  font-family:'JetBrains Mono',monospace;
  font-size:.6rem;letter-spacing:.16em;color:var(--muted);
  text-transform:uppercase;margin-bottom:1rem;
}

/* â•â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â•â• */
.hero{
  min-height:100vh;display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  text-align:center;padding:6rem 2rem 4rem;
  position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 70% 45% at 50% 15%,
    rgba(56,189,248,.07) 0%,transparent 70%);
}
.hero-eye{
  font-family:'JetBrains Mono',monospace;
  font-size:.68rem;letter-spacing:.22em;
  color:var(--muted);text-transform:uppercase;margin-bottom:1.4rem;
}
.hero h1{
  font-size:clamp(2.4rem,5.5vw,4.5rem);
  font-weight:600;letter-spacing:-.04em;line-height:1.08;
  margin-bottom:1.4rem;max-width:720px;
}
.hero h1 em{
  font-style:normal;
  background:linear-gradient(135deg,var(--accent),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.hero-sub{
  max-width:500px;font-size:1rem;font-weight:300;
  color:var(--muted);margin-bottom:2.8rem;line-height:1.8;
}
.scroll-cue{
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
  font-family:'JetBrains Mono',monospace;
  font-size:.6rem;letter-spacing:.16em;color:var(--muted);
  animation:bob 2.2s ease-in-out infinite;
}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(7px)}}

/* â•â•â•â•â•â•â•â•â•â•â• FADE UP â•â•â•â•â•â•â•â•â•â•â• */
.fu{opacity:0;transform:translateY(22px);transition:opacity .5s ease,transform .5s ease}
.fu.in{opacity:1;transform:translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â• INLINE STYLES â•â•â•â•â•â•â•â•â•â•â• */
.hl{color:var(--accent);font-weight:500}
.hl2{color:var(--purple);font-weight:500}
.hl3{color:var(--green);font-weight:500}
.hlw{color:var(--yellow);font-weight:500}
.hld{color:var(--red);font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â• SPECTRUM (S1) â•â•â•â•â•â•â•â•â•â•â• */
.spec-item{
  display:flex;align-items:center;gap:.7rem;
  padding:.5rem .75rem;background:var(--surface);
  border:1px solid var(--border);border-radius:7px;
  cursor:pointer;transition:all .2s;margin-bottom:.35rem;
}
.spec-item:hover,.spec-item.open{border-color:var(--accent);background:var(--bg3)}
.spec-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.spec-name{font-size:.82rem;font-weight:500;flex:1}
.spec-bar-bg{flex:2;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.spec-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:2px}
.spec-tag{
  font-family:'JetBrains Mono',monospace;font-size:.55rem;
  letter-spacing:.08em;padding:.12rem .4rem;border-radius:3px;
  background:var(--subtle);color:var(--muted);white-space:nowrap;
}
.spec-detail{
  display:none;padding:.38rem .75rem .5rem;margin-left:.3rem;
  font-size:.78rem;color:var(--muted);line-height:1.6;
  border-left:2px solid var(--accent);
}
.spec-detail.show{display:block}

/* â•â•â•â•â•â•â•â•â•â•â• PHONE/QUEUE VIZ â•â•â•â•â•â•â•â•â•â•â• */
.flow-row{
  display:flex;align-items:center;gap:.5rem;
  padding:.65rem .8rem;background:var(--surface);
  border:1px solid var(--border);border-radius:7px;
  margin-bottom:.5rem;position:relative;overflow:hidden;
}
.flow-node{
  padding:.3rem .7rem;border-radius:5px;
  font-family:'JetBrains Mono',monospace;font-size:.7rem;
  font-weight:500;white-space:nowrap;border:1px solid;
}
.fn-a{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.07)}
.fn-b{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,.07)}
.fn-q{border-color:var(--green);color:var(--green);background:rgba(74,222,128,.07)}
.fn-d{border-color:var(--red);color:var(--red);background:rgba(248,113,113,.07)}
.flow-line{flex:1;height:1px;background:var(--border);position:relative}
.flow-line.active{background:var(--accent)}
.flow-line.broken{background:var(--red);opacity:.4}
.pkt{
  position:absolute;top:-4px;width:8px;height:8px;border-radius:50%;
  background:var(--accent);animation:pktmove 1.8s linear infinite;
}
@keyframes pktmove{
  0%{left:-5px;opacity:0}10%{opacity:1}90%{opacity:1}100%{left:100%;opacity:0}
}
.flow-label{font-size:.7rem;color:var(--muted);margin-left:auto;white-space:nowrap}

/* â•â•â•â•â•â•â•â•â•â•â• MESSAGE ANATOMY â•â•â•â•â•â•â•â•â•â•â• */
.msg-envelope{width:100%}
.msg-header{
  background:linear-gradient(135deg,rgba(56,189,248,.07),rgba(167,139,250,.07));
  border:1px solid var(--accent);border-radius:8px 8px 0 0;
  padding:.8rem 1rem;
}
.msg-body{
  background:var(--bg);border:1px solid var(--border);
  border-top:none;border-radius:0 0 8px 8px;padding:.8rem 1rem;
}
.msg-section-title{
  font-family:'JetBrains Mono',monospace;font-size:.6rem;
  letter-spacing:.14em;text-transform:uppercase;margin-bottom:.5rem;
}
.msg-field{
  display:flex;justify-content:space-between;align-items:center;
  gap:.8rem;padding:.2rem 0;border-bottom:1px solid var(--border);
  font-size:.78rem;
}
.msg-field:last-child{border-bottom:none}
.msg-key{
  font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);
}
.msg-val{color:var(--text);font-weight:500;text-align:right}
.msg-opaque{
  font-style:italic;color:var(--muted);font-size:.78rem;
  padding:.45rem .7rem;background:var(--subtle);border-radius:5px;margin-top:.35rem;
}
.pipe-anim{
  margin-top:.8rem;height:20px;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;overflow:hidden;position:relative;
}
.pipe-fill{
  position:absolute;top:0;bottom:0;left:0;
  background:linear-gradient(90deg,var(--accent),var(--purple),var(--green));
  border-radius:10px;animation:pipeslide 2.8s ease-in-out infinite;
}
@keyframes pipeslide{
  0%{left:0;width:0%}40%{width:55%}60%{left:35%;width:55%}100%{left:100%;width:0%}
}
.pipe-dot{
  position:absolute;top:4px;width:12px;height:12px;border-radius:50%;
  background:#fff;opacity:.85;animation:dotslide 2.8s ease-in-out infinite;
}
@keyframes dotslide{
  0%{left:-8px;opacity:0}5%{opacity:1}95%{opacity:1}100%{left:calc(100% + 4px);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â• DELIVERY GUARANTEES â•â•â•â•â•â•â•â•â•â•â• */
.dlv-row{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:.75rem .95rem;margin-bottom:.55rem;
}
.dlv-head{display:flex;align-items:center;gap:.65rem;margin-bottom:.45rem}
.dlv-badge{
  font-family:'JetBrains Mono',monospace;font-size:.6rem;
  letter-spacing:.07em;padding:.18rem .55rem;border-radius:4px;white-space:nowrap;
}
.badge-amo{background:rgba(248,113,113,.12);color:var(--red)}
.badge-alo{background:rgba(250,204,21,.12);color:var(--yellow)}
.badge-eo{background:rgba(107,117,146,.12);color:var(--muted);text-decoration:line-through}
.dlv-track{display:flex;align-items:center;gap:3px;flex-wrap:wrap;margin-bottom:.3rem}
.dmsg{
  width:22px;height:15px;border-radius:3px;font-size:8px;
  display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;border:1px solid;
}
.dm-ok{background:rgba(74,222,128,.12);border-color:var(--green);color:var(--green)}
.dm-lost{background:rgba(248,113,113,.07);border-color:rgba(248,113,113,.25);color:rgba(248,113,113,.35)}
.dm-dup{background:rgba(250,204,21,.12);border-color:var(--yellow);color:var(--yellow)}
.dlv-note{font-size:.75rem;color:var(--muted)}

/* â•â•â•â•â•â•â•â•â•â•â• QUEUE WORKERS â•â•â•â•â•â•â•â•â•â•â• */
.q-track{
  display:flex;align-items:center;gap:.35rem;
  padding:.65rem .75rem;background:var(--surface);
  border:1px solid var(--border);border-radius:7px;margin-bottom:.5rem;overflow:hidden;
}
.q-label{
  font-family:'JetBrains Mono',monospace;font-size:.58rem;
  letter-spacing:.1em;color:var(--muted);min-width:60px;
}
.q-msgs{display:flex;gap:4px;flex:1;align-items:center}
.qm{
  width:26px;height:20px;border-radius:3px;
  font-family:'JetBrains Mono',monospace;font-size:8px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid var(--accent);color:var(--accent);background:rgba(56,189,248,.08);
}
.qm.locked{border-color:var(--yellow);color:var(--yellow);background:rgba(250,204,21,.08)}
.worker-row{
  display:flex;align-items:center;gap:.5rem;
  padding:.45rem .75rem;background:var(--bg3);
  border:1px solid var(--border);border-radius:6px;font-size:.78rem;margin-bottom:.35rem;
}
.w-dot{width:8px;height:8px;border-radius:50%}
.w-busy{background:var(--green)}.w-idle{background:var(--muted)}

/* â•â•â•â•â•â•â•â•â•â•â• TOPIC FAN-OUT â•â•â•â•â•â•â•â•â•â•â• */
.topic-box{
  background:var(--surface);border:1px solid var(--purple);
  border-radius:7px;padding:.6rem 1rem;text-align:center;
  margin-bottom:.85rem;font-size:.82rem;font-weight:500;color:var(--purple);
}
.sub-row{
  display:flex;align-items:center;gap:.6rem;
  padding:.45rem .75rem;background:var(--bg3);
  border:1px solid var(--border);border-radius:6px;margin-bottom:.4rem;
}
.sub-line{width:28px;height:1px;background:var(--purple);position:relative;flex-shrink:0}
.sub-pkt{
  position:absolute;top:-3px;left:0;
  width:6px;height:6px;border-radius:50%;background:var(--purple);
}
.sub-name{font-size:.78rem;font-weight:500;flex:1}
.sub-filter{
  font-family:'JetBrains Mono',monospace;font-size:.57rem;
  color:var(--muted);padding:.1rem .38rem;background:var(--subtle);border-radius:3px;
}
.fan-badge{
  margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.57rem;
  padding:.12rem .45rem;border-radius:3px;
  background:rgba(167,139,250,.1);color:var(--purple);
}

/* â•â•â•â•â•â•â•â•â•â•â• PEEK-LOCK â•â•â•â•â•â•â•â•â•â•â• */
.pl-step{
  display:flex;align-items:center;gap:.55rem;
  padding:.5rem .75rem;border-radius:6px;margin-bottom:.38rem;
  border:1px solid var(--border);background:var(--surface);font-size:.8rem;
}
.pl-step.warn{border-color:var(--yellow)}
.pl-step.danger{border-color:var(--red)}
.pl-step.success{border-color:var(--green)}
.pl-icon{font-size:.95rem;flex-shrink:0}
.pl-text{flex:1;font-size:.8rem}
.pl-badge{
  font-family:'JetBrains Mono',monospace;font-size:.58rem;
  padding:.12rem .45rem;border-radius:3px;white-space:nowrap;
}
.pb-lock{background:rgba(250,204,21,.1);color:var(--yellow)}
.pb-fail{background:rgba(248,113,113,.1);color:var(--red)}
.pb-ok{background:rgba(74,222,128,.1);color:var(--green)}
.pb-dlq{background:rgba(248,113,113,.07);color:var(--red);border:1px solid var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â• SESSIONS â•â•â•â•â•â•â•â•â•â•â• */
.sess-lane{
  display:flex;align-items:center;gap:.45rem;
  padding:.45rem .65rem;background:var(--surface);
  border:1px solid var(--border);border-radius:6px;margin-bottom:.4rem;
}
.sess-id{
  font-family:'JetBrains Mono',monospace;font-size:.6rem;
  padding:.18rem .45rem;border-radius:4px;min-width:70px;text-align:center;flex-shrink:0;
}
.s-cyan{background:rgba(56,189,248,.1);border:1px solid var(--accent);color:var(--accent)}
.s-purple{background:rgba(167,139,250,.1);border:1px solid var(--purple);color:var(--purple)}
.s-green{background:rgba(74,222,128,.1);border:1px solid var(--green);color:var(--green)}
.sess-msgs{display:flex;gap:2px;flex:1}
.smsg{
  width:24px;height:18px;border-radius:3px;
  font-family:'JetBrains Mono',monospace;font-size:7px;
  display:flex;align-items:center;justify-content:center;border:1px solid;
}
.sess-worker{font-size:.72rem;font-weight:500;white-space:nowrap}

/* â•â•â•â•â•â•â•â•â•â•â• TRANSACTION â•â•â•â•â•â•â•â•â•â•â• */
.tx-ops{display:flex;gap:.45rem;margin-bottom:.7rem;flex-wrap:wrap}
.tx-op{
  flex:1;min-width:78px;background:var(--surface);
  border:1px solid var(--border);border-radius:7px;
  padding:.55rem .7rem;text-align:center;transition:all .4s;
}
.tx-op.commit{border-color:var(--green);background:rgba(74,222,128,.07)}
.tx-op.rollback{border-color:var(--red);background:rgba(248,113,113,.07)}
.tx-op-lbl{font-size:.68rem;color:var(--muted);margin-bottom:.18rem;font-family:'JetBrains Mono',monospace;font-size:.6rem}
.tx-op-name{font-size:.75rem}
.tx-btns{display:flex;gap:.45rem}
.tx-btn{
  flex:1;padding:.42rem;border-radius:6px;border:1px solid;
  font-family:'JetBrains Mono',monospace;font-size:.62rem;
  letter-spacing:.08em;cursor:pointer;background:transparent;color:inherit;
  transition:all .2s;
}
.tb-c{border-color:var(--green);color:var(--green)}.tb-c:hover{background:rgba(74,222,128,.1)}
.tb-r{border-color:var(--red);color:var(--red)}.tb-r:hover{background:rgba(248,113,113,.1)}
#txResult{
  margin-top:.55rem;font-family:'JetBrains Mono',monospace;
  font-size:.75rem;min-height:1.3rem;color:var(--muted);
}

/* â•â•â•â•â•â•â•â•â•â•â• COMPARE TABLE â•â•â•â•â•â•â•â•â•â•â• */
.ctbl{width:100%;border-collapse:collapse;font-size:.78rem}
.ctbl th{
  font-family:'JetBrains Mono',monospace;font-size:.58rem;
  letter-spacing:.12em;color:var(--muted);text-align:left;
  padding:.45rem .65rem;border-bottom:1px solid var(--border);
}
.ctbl td{
  padding:.5rem .65rem;border-bottom:1px solid rgba(42,47,66,.5);
  color:var(--muted);vertical-align:top;
}
[data-theme="light"] .ctbl td{border-bottom:1px solid rgba(203,213,225,.5)}
.ctbl tr:hover td{color:var(--text);background:var(--bg3)}
.tsvc{font-weight:600;color:var(--text);white-space:nowrap}

/* â•â•â•â•â•â•â•â•â•â•â• NOT-CARDS â•â•â•â•â•â•â•â•â•â•â• */
.not-grid{display:grid;grid-template-columns:1fr 1fr;gap:.55rem;margin-top:1rem}
.not-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:.75rem .95rem;transition:all .2s;
}
.not-card:hover{border-color:var(--red)}
.not-title{font-size:.82rem;font-weight:600;color:var(--red);margin-bottom:.28rem}
.not-body{font-size:.76rem;color:var(--muted);line-height:1.55}

/* â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  .stage-grid{grid-template-columns:1fr;gap:2rem}
  .stage-grid.flip{direction:ltr}
  .sidenav{display:none}
  .not-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div id="prog"></div>

<!-- TOP BAR -->
<div class="topbar">
  <span class="topbar-title">Azure Service Bus â€” First Principles</span>
  <div class="topbar-right">
    <span class="stage-label" id="stageLbl">INTRO</span>
    <div class="toggle-wrap">
      <span id="tl1">DARK</span>
      <label class="toggle-switch">
        <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
        <div class="toggle-track"></div>
        <div class="toggle-thumb" id="thumbIcon">ğŸŒ™</div>
      </label>
      <span id="tl2">LIGHT</span>
    </div>
  </div>
</div>

<!-- SIDE NAV -->
<nav class="sidenav" id="sideNav">
  <a class="active" href="#hero"></a>
  <a href="#s1"></a><a href="#s2"></a><a href="#s3"></a>
  <a href="#s4"></a><a href="#s5"></a><a href="#s6"></a>
  <a href="#s7"></a><a href="#s8"></a><a href="#s9"></a>
  <a href="#s10"></a><a href="#s11"></a>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â• -->
<section class="hero" id="hero">
  <div class="hero-eye">First Principles Â· No Marketing Â· Architect Edition</div>
  <h1>Azure Service Bus<br><em>from the ground up</em></h1>
  <p class="hero-sub">Built on one assumption: every component will fail, every network will drop packets, every message may duplicate. Service Bus exists to solve these problems.</p>
  <div class="scroll-cue">
    <svg width="14" height="18" viewBox="0 0 14 18" fill="none">
      <path d="M7 1v16M1 11l6 6 6-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    SCROLL
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 1 â€” DISTRIBUTED FAILURE â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s1">
  <div class="stage-grid">
    <div class="fu">
      <div class="stg-num">Stage 1 of 11 Â· Foundation</div>
      <h2>Distributed systems fail by default.</h2>
      <p class="narr">Networks partition. Services restart mid-request. Clocks drift. Messages duplicate. These aren't edge cases â€” they're the baseline. <strong>Every Service Bus pattern exists to answer: what happens when something fails mid-flight?</strong></p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>If your architecture hasn't explicitly answered the failure question, it has answered it implicitly â€” usually with <strong>silent data loss</strong>. Reliability must be designed in, not bolted on after an incident.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Same Azure region means reliable networking." Same-region does not eliminate transient DNS failures, VM restarts during platform updates, or packet loss under heavy load.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Failure Modes â€” always active</div>
      <canvas id="failCanvas" width="340" height="260" style="max-width:100%"></canvas>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 2 â€” COUPLING SPECTRUM â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s2">
  <div class="stage-grid flip">
    <div class="fu">
      <div class="stg-num">Stage 2 of 11 Â· Mental Model</div>
      <h2>Not all integration has the same coupling.</h2>
      <p class="narr">Every pattern sits on a spectrum from tight to fully decoupled. Moving right gains resilience â€” but adds operational complexity and eventual consistency. <strong>Click any row to expand.</strong></p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>Most outages trace back to a <strong>tightly coupled dependency</strong> that failed and cascaded. Coupling level is the most consequential architectural decision you make.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"More decoupling is always better." Full async requires eventual consistency and harder debugging. Use the minimum decoupling that satisfies your SLA requirements.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Coupling Spectrum â€” click to expand</div>
      <div id="spectrumViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 3 â€” TEMPORAL COUPLING â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s3">
  <div class="stage-grid">
    <div class="fu">
      <div class="stg-num">Stage 3 of 11 Â· Core Concept</div>
      <h2>Temporal coupling: the phone call problem.</h2>
      <p class="narr">A phone call requires both parties online simultaneously. A text message does not. <strong>HTTP is a phone call.</strong> Service Bus is a text message â€” the sender moves on immediately, the receiver processes when ready.</p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>In a chain of 8 synchronous services at 99.9% uptime each: <strong>99.9%â¸ â‰ˆ 99.2%</strong>. Add a queue between them and each service operates independently at its own 99.9%.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Retry logic solves temporal coupling." Retries shrink the failure window but never eliminate it. In-memory buffers fill up. Queues are the only true structural solution.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Synchronous vs Asynchronous failure propagation</div>
      <div id="coupleViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 4 â€” MESSAGE ANATOMY â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s4">
  <div class="stage-grid flip">
    <div class="fu">
      <div class="stg-num">Stage 4 of 11 Â· Structure</div>
      <h2>A message is an envelope, not just a payload.</h2>
      <p class="narr">The broker reads the envelope. Only your consumer reads the letter. Headers carry routing metadata, correlation IDs, and idempotency keys. <strong>The body is opaque bytes to Service Bus â€” it never inspects it.</strong></p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>Without a <strong>Correlation ID</strong>, debugging a failed payment across 6 services means joining logs by timestamp â€” unreliable guesswork. One header field reconstructs the full journey of any message.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"I can put routing logic in the JSON body." The broker ignores your body entirely. Routing decisions must be encoded in headers â€” Subject, SessionId, or user-defined properties.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Message anatomy â€” moving through the broker</div>
      <div id="envelopeViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 5 â€” DELIVERY GUARANTEES â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s5">
  <div class="stage-grid">
    <div class="fu">
      <div class="stg-num">Stage 5 of 11 Â· Guarantees</div>
      <h2>Exactly-once is mostly an illusion.</h2>
      <p class="narr">Every broker trades off: lose messages occasionally, or deliver them more than once. Exactly-once requires distributed consensus that is extremely expensive. The practical answer is <strong>at-least-once + idempotent consumers</strong>.</p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>A payment service that isn't idempotent will <strong>double-charge customers</strong> when the broker retries a timed-out delivery. Store processed MessageIds and short-circuit on duplicates.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Service Bus duplicate detection gives exactly-once." It suppresses identical MessageIds within a time window â€” it doesn't guarantee exactly-once <em>processing</em>. A consumer can crash after processing but before completing the lock.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Delivery guarantee comparison</div>
      <div id="deliveryViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 6 â€” QUEUES â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s6">
  <div class="stage-grid flip">
    <div class="fu">
      <div class="stg-num">Stage 6 of 11 Â· Queue Pattern</div>
      <h2>A queue is a deli counter with infinite tickets.</h2>
      <p class="narr">Customers take a number. Workers serve one ticket at a time. Adding workers increases throughput without touching producers. <strong>The queue absorbs burst</strong> â€” 10,000 orders arrive in 60 seconds, processed at the pace workers can sustain.</p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>Without a queue, a spike either crashes your processing service or forces <strong>permanent over-provisioning</strong> for load that lasts 10 minutes a day. Queues let you provision for average throughput, not peak.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Auto-scaling solves this." New instances take 2â€“5 minutes to boot. The queue absorbs the burst instantly. Auto-scaling and queues are complements, not alternatives.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Competing consumers â€” queue-based load leveling</div>
      <div id="queueViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 7 â€” TOPICS â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s7">
  <div class="stage-grid">
    <div class="fu">
      <div class="stg-num">Stage 7 of 11 Â· Topic Pattern</div>
      <h2>A topic is a printing press. Every subscriber gets their own edition.</h2>
      <p class="narr">One message published to a topic creates an independent copy per subscription. Subscribers filter what they care about. <strong>The publisher has zero knowledge of who is listening</strong> â€” adding a new consumer requires no producer code changes.</p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>An <em>OrderPlaced</em> event should trigger inventory reservation, email confirmation, fraud check, and analytics simultaneously. A topic with 4 subscriptions achieves this with <strong>no producer changes</strong> when a new consumer is added.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"I need multiple queues for fan-out." That forces the producer to know every consumer â€” tight coupling. A topic subscription lets consumers register themselves. The producer stays ignorant.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Topic fan-out â€” one message, many subscribers</div>
      <div id="topicViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 8 â€” PEEK-LOCK â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s8">
  <div class="stage-grid flip">
    <div class="fu">
      <div class="stg-num">Stage 8 of 11 Â· Reliability</div>
      <h2>Peek-Lock: the safety net under every delivery.</h2>
      <p class="narr">When a worker fetches a message, the broker locks it â€” not deletes it. The worker must complete, abandon, or defer. If it crashes, the lock expires and the message reappears. <strong>This is how at-least-once delivery actually works under failure.</strong></p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>Without Peek-Lock, a crash between "receive" and "finish processing" means the message is <strong>permanently gone</strong>. The order lost. The payment unconfirmed. There is no recovery.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"ReceiveAndDelete is a valid optimization." It saves one round trip but permanently deletes the message before knowing if processing succeeded. Any crash causes irrecoverable data loss.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Peek-Lock lifecycle + Dead Letter Queue</div>
      <div id="peeklockViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 9 â€” SESSIONS â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s9">
  <div class="stage-grid">
    <div class="fu">
      <div class="stg-num">Stage 9 of 11 Â· Ordering</div>
      <h2>Sessions: one lane per conversation.</h2>
      <p class="narr">Competing consumers destroy ordering â€” Worker 2 might process Step 3 before Worker 1 finishes Step 1. Sessions assign all messages with the same SessionId to one worker at a time. <strong>One dedicated lane per customer, per workflow.</strong></p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>A loan workflow â€” submit â†’ validate â†’ credit-score â†’ approve â€” must run in sequence per application. Sessions guarantee this with <strong>full horizontal scale</strong> across sessions.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Sessions guarantee global ordering." Sessions guarantee ordering <em>within</em> a SessionId only. Messages across different sessions interleave freely. Global ordering requires a single consumer.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Session lanes â€” ordered per workflow</div>
      <div id="sessionsViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 10 â€” TRANSACTIONS â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s10">
  <div class="stage-grid flip">
    <div class="fu">
      <div class="stg-num">Stage 10 of 11 Â· Atomicity</div>
      <h2>Either everything happens, or nothing does.</h2>
      <p class="narr">Service Bus supports cross-entity transactions â€” receive from one queue, send to two others, complete the original â€” all or nothing. <strong>Any failure rolls the entire unit back</strong> as if nothing happened.</p>
      <div class="cards">
        <div class="card"><div class="card-lbl lbl-why">â†— Why It Matters</div>
        <p>A transfer service receives "move $100" and sends "debit A" + "credit B". Crash after debit but before credit: <strong>money disappears</strong>. Transactions prevent this. Without them, you write complex compensating sagas.</p></div>
        <div class="card"><div class="card-lbl lbl-mis">âš  Common Misconception</div>
        <p>"Transactions span my DB and Service Bus." They don't. Service Bus transactions cover only Service Bus entities. For DB + broker atomicity, use the <strong>Outbox Pattern</strong>.</p></div>
      </div>
    </div>
    <div class="vbox fu">
      <div class="vbox-title">Atomic transaction â€” simulate commit or failure</div>
      <div id="txViz"></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• STAGE 11 â€” WHAT IT IS NOT â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-divider"></div>
<section class="stage" id="s11">
  <div class="stage-grid full fu">
    <div>
      <div class="stg-num">Stage 11 of 11 Â· Boundaries</div>
      <h2>Knowing what Service Bus is not matters as much as knowing what it is.</h2>
      <p class="narr">Choosing the wrong primitive is a common and expensive mistake. Use the table and cards below to understand the boundaries.</p>
    </div>
    <div class="vbox" style="margin-top:1.2rem;padding:1rem">
      <table class="ctbl" id="compareTable"></table>
    </div>
    <div class="not-grid" id="notGrid"></div>
  </div>
</section>

<div class="stage-divider"></div>
<footer style="text-align:center;padding:3.5rem 2rem;font-family:'JetBrains Mono',monospace;font-size:.62rem;letter-spacing:.14em;color:var(--muted)">
  AZURE SERVICE BUS Â· FIRST PRINCIPLES Â· DISTRIBUTED SYSTEMS FAIL BY DEFAULT
</footer>

<script>
/* â”€â”€ THEME TOGGLE â”€â”€ */
function toggleTheme() {
  const on = document.getElementById('themeToggle').checked;
  document.documentElement.setAttribute('data-theme', on ? 'light' : 'dark');
  document.getElementById('thumbIcon').textContent = on ? 'â˜€ï¸' : 'ğŸŒ™';
}

/* â”€â”€ PROGRESS + SCROLL â”€â”€ */
const allSections = ['hero','s1','s2','s3','s4','s5','s6','s7','s8','s9','s10','s11'];
const stageNames = ['INTRO','STAGE 1','STAGE 2','STAGE 3','STAGE 4','STAGE 5',
  'STAGE 6','STAGE 7','STAGE 8','STAGE 9','STAGE 10','STAGE 11'];

window.addEventListener('scroll', () => {
  const pct = window.scrollY / (document.body.scrollHeight - window.innerHeight) * 100;
  document.getElementById('prog').style.width = pct + '%';
  const dots = document.querySelectorAll('.sidenav a');
  allSections.forEach((id, i) => {
    const el = document.getElementById(id); if (!el) return;
    const r = el.getBoundingClientRect();
    if (r.top <= window.innerHeight * .55 && r.bottom >= window.innerHeight * .55) {
      dots.forEach(d => d.classList.remove('active'));
      if (dots[i]) dots[i].classList.add('active');
      document.getElementById('stageLbl').textContent = stageNames[i] || '';
    }
  });
  document.querySelectorAll('.fu').forEach(el => {
    if (el.getBoundingClientRect().top < window.innerHeight * .88) el.classList.add('in');
  });
});

// initial check
document.querySelectorAll('.fu').forEach(el => {
  if (el.getBoundingClientRect().top < window.innerHeight * .88) el.classList.add('in');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAILURE CANVAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const canvas = document.getElementById('failCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 340, H = 260;
  const nodes = [
    { x: 55,  y: 65,  label: 'Service A',  color: '#38bdf8', state: 'ok' },
    { x: 180, y: 45,  label: 'Service B',  color: '#38bdf8', state: 'ok' },
    { x: 300, y: 75,  label: 'Service C',  color: '#38bdf8', state: 'ok' },
    { x: 70,  y: 185, label: 'Database',   color: '#4ade80', state: 'ok' },
    { x: 185, y: 195, label: 'Cache',      color: '#facc15', state: 'ok' },
    { x: 295, y: 195, label: 'Queue',      color: '#fb923c', state: 'ok' },
  ];
  const edges = [[0,1],[1,2],[0,3],[1,4],[2,5],[3,4],[4,5],[0,2],[1,3]];
  let failures = [];
  let animT = 0;

  function draw() {
    ctx.clearRect(0, 0, W, H);

    // Draw edges
    edges.forEach(([a, b]) => {
      const na = nodes[a], nb = nodes[b];
      const fail = failures.includes(a) || failures.includes(b);
      ctx.beginPath();
      ctx.moveTo(na.x, na.y);
      ctx.lineTo(nb.x, nb.y);
      ctx.strokeStyle = fail ? 'rgba(248,113,113,.35)' : 'rgba(107,117,146,.35)';
      ctx.lineWidth = 1;
      ctx.setLineDash(fail ? [4, 4] : []);
      ctx.stroke();
      ctx.setLineDash([]);
    });

    // Draw nodes
    nodes.forEach((n, i) => {
      const down = failures.includes(i);
      const pulse = .5 + .5 * Math.sin(animT * .04 + i);

      if (down) {
        ctx.beginPath();
        ctx.arc(n.x, n.y, 22 + pulse * 5, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(248,113,113,.2)';
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(n.x, n.y, 18, 0, Math.PI * 2);
      ctx.fillStyle = down ? 'rgba(248,113,113,.12)' : n.color + '12';
      ctx.fill();
      ctx.strokeStyle = down ? '#f87171' : n.color;
      ctx.lineWidth = down ? 1.8 : 1.3;
      ctx.stroke();

      ctx.fillStyle = down ? '#f87171' : n.color;
      ctx.font = '9px JetBrains Mono';
      ctx.textAlign = 'center';
      ctx.fillText(down ? 'âœ• DOWN' : n.label, n.x, n.y + 3);
    });

    // Hint
    ctx.fillStyle = '#6b7592';
    ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'left';
    ctx.fillText('Click â†’ Simulate failure', 8, H - 6);

    animT++;
    requestAnimationFrame(draw);
  }

  canvas.addEventListener('click', () => {
    failures = [];
    const count = 1 + Math.floor(Math.random() * 3);
    const indices = [...Array(nodes.length).keys()].sort(() => Math.random() - .5);
    failures = indices.slice(0, count);
    setTimeout(() => { failures = []; }, 3000);
  });

  draw();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPECTRUM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('spectrumViz'); if (!c) return;
  const items = [
    { name: 'Direct HTTP',       pct: 12, color: '#f87171', tag: 'SYNC',
      detail: 'Both services must be online simultaneously. Simple to debug. Availability = product of all dependencies. Use for: user-facing reads requiring immediate consistency.' },
    { name: 'Database Polling',  pct: 30, color: '#fb923c', tag: 'SEMI-SYNC',
      detail: 'Consumer polls shared table for new rows. Adds DB load, creates latency floor = poll interval. Avoid at scale. Practical only with existing DB infrastructure.' },
    { name: 'Service Bus Queue', pct: 58, color: '#4ade80', tag: 'ASYNC',
      detail: 'Producer writes, consumer reads at own pace. One-to-one. Temporal decoupling achieved. Broker holds messages during consumer downtime. Rich: sessions, DLQ, transactions.' },
    { name: 'Topics & Pub/Sub',  pct: 78, color: '#38bdf8', tag: 'ASYNC FANOUT',
      detail: 'One message, many independent subscribers. Each subscription isolated. Adding a new consumer requires zero producer changes. Use for fan-out workflows.' },
    { name: 'Event Streaming',   pct: 96, color: '#a78bfa', tag: 'DECOUPLED LOG',
      detail: 'Append-only log with replay. Consumers maintain own offset. Events persist by time/size, not acknowledgement. Use Event Hubs for telemetry at 1M+ events/s, not Service Bus.' },
  ];
  items.forEach((item, i) => {
    c.insertAdjacentHTML('beforeend', `
      <div class="spec-item" onclick="this.classList.toggle('open');document.getElementById('sd${i}').classList.toggle('show')">
        <div class="spec-dot" style="background:${item.color}"></div>
        <span class="spec-name">${item.name}</span>
        <div class="spec-bar-bg"><div class="spec-bar" style="width:${item.pct}%"></div></div>
        <span class="spec-tag">${item.tag}</span>
      </div>
      <div class="spec-detail" id="sd${i}">${item.detail}</div>
    `);
  });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMPORAL COUPLING VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('coupleViz'); if (!c) return;
  c.innerHTML = `
    <div style="font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin-bottom:.35rem">SYNCHRONOUS â€” cascading failure</div>
    <div class="flow-row">
      <div class="flow-node fn-d">A: DOWN</div>
      <div class="flow-line broken"></div>
      <div class="flow-node fn-d">B: TIMEOUT</div>
      <div class="flow-line broken"></div>
      <div class="flow-node fn-d">C: CRASH</div>
      <div class="flow-line broken"></div>
      <div class="flow-node fn-d">D: FAIL</div>
    </div>

    <div style="font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin:.75rem 0 .35rem">SYNCHRONOUS â€” receiver down</div>
    <div class="flow-row">
      <div class="flow-node fn-a">Service A</div>
      <div class="flow-line broken"></div>
      <span style="color:var(--red);font-size:1.1rem;flex-shrink:0">âœ•</span>
      <div class="flow-line broken"></div>
      <div class="flow-node fn-d">B: DOWN</div>
      <span class="flow-label" style="color:var(--red);font-size:.72rem">A fails immediately</span>
    </div>

    <div style="font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin:.75rem 0 .35rem">ASYNCHRONOUS â€” decoupled</div>
    <div class="flow-row">
      <div class="flow-node fn-a">Service A</div>
      <div class="flow-line active" style="position:relative"><div class="pkt"></div></div>
      <div class="flow-node fn-q">Broker</div>
      <div class="flow-line active" style="position:relative"><div class="pkt" style="animation-delay:.9s"></div></div>
      <div class="flow-node fn-b">Service B</div>
    </div>

    <div style="font-family:'JetBrains Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin:.75rem 0 .35rem">ASYNCHRONOUS â€” B is offline</div>
    <div class="flow-row">
      <div class="flow-node fn-a">A âœ“ continues</div>
      <div class="flow-line active" style="position:relative"><div class="pkt"></div></div>
      <div class="flow-node fn-q">Broker holds</div>
      <div class="flow-line broken"></div>
      <div class="flow-node fn-d">B: DOWN</div>
      <span class="flow-label" style="color:var(--green)">msg safe</span>
    </div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENVELOPE VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('envelopeViz'); if (!c) return;
  c.innerHTML = `
    <div class="msg-envelope">
      <div class="msg-header">
        <div class="msg-section-title" style="color:var(--accent)">HEADER â€” Broker reads this</div>
        <div class="msg-field"><span class="msg-key">MessageId</span><span class="msg-val" style="font-family:'JetBrains Mono',monospace;font-size:.72rem">msg-7f3a9c21</span></div>
        <div class="msg-field"><span class="msg-key">CorrelationId</span><span class="msg-val" style="color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:.72rem">order-2f8e1b</span></div>
        <div class="msg-field"><span class="msg-key">SessionId</span><span class="msg-val" style="font-family:'JetBrains Mono',monospace;font-size:.72rem">customer-42</span></div>
        <div class="msg-field"><span class="msg-key">Subject</span><span class="msg-val" style="font-family:'JetBrains Mono',monospace;font-size:.72rem">order.placed</span></div>
        <div class="msg-field"><span class="msg-key">TTL</span><span class="msg-val">30 minutes</span></div>
        <div class="msg-field"><span class="msg-key">DeliveryCount</span><span class="msg-val" style="color:var(--yellow)">1</span></div>
      </div>
      <div class="msg-body">
        <div class="msg-section-title" style="color:var(--muted)">BODY â€” Broker never reads this</div>
        <div class="msg-opaque">{"orderId":"ORD-9912","amount":149.99,"currency":"GBP","items":[â€¦]}<br>opaque bytes â€” broker has no knowledge of contents</div>
      </div>
    </div>
    <div class="pipe-anim"><div class="pipe-fill"></div><div class="pipe-dot"></div></div>
    <div style="text-align:center;font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:.38rem">message in flight through the broker</div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DELIVERY GUARANTEES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('deliveryViz'); if (!c) return;
  function msgs(arr) {
    return arr.map((t,i) =>
      `<div class="dmsg ${t==='ok'?'dm-ok':t==='lost'?'dm-lost':'dm-dup'}">${t==='ok'?i+1:t==='lost'?'â€”':'!'}</div>`
    ).join('');
  }
  c.innerHTML = `
    <div class="dlv-row">
      <div class="dlv-head"><span class="dlv-badge badge-amo">AT-MOST-ONCE</span><span style="font-size:.76rem;color:var(--muted)">Fast. Lossy. Fire and forget.</span></div>
      <div class="dlv-track">${msgs(['ok','ok','lost','ok','lost','ok','ok','lost','ok'])}</div>
      <div class="dlv-note">Messages dropped on crash or timeout. Suitable: metrics, telemetry where occasional loss is acceptable.</div>
    </div>
    <div class="dlv-row">
      <div class="dlv-head"><span class="dlv-badge badge-alo">AT-LEAST-ONCE</span><span style="font-size:.76rem;color:var(--muted)">Safe. May duplicate. Requires idempotency.</span></div>
      <div class="dlv-track">${msgs(['ok','ok','dup','dup','ok','ok','dup','ok','ok'])}</div>
      <div class="dlv-note">! = duplicate delivery. Consumer must check MessageId and short-circuit already-processed messages.</div>
    </div>
    <div class="dlv-row">
      <div class="dlv-head"><span class="dlv-badge badge-eo">EXACTLY-ONCE</span><span style="font-size:.76rem;color:var(--muted)">Requires Outbox Pattern.</span></div>
      <div style="font-size:.8rem;color:var(--muted);padding:.2rem 0;line-height:1.6">Requires distributed 2PC across broker and consumer storage. Adds significant latency.
      Practical answer: <strong style="color:var(--text)">at-least-once + idempotent consumer = functionally equivalent</strong>.</div>
    </div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUEUE / WORKERS VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('queueViz'); if (!c) return;
  c.innerHTML = `
    <div class="q-track">
      <div class="q-label">QUEUE</div>
      <div class="q-msgs">
        <div class="qm">M1</div><div class="qm">M2</div>
        <div class="qm locked">M3ğŸ”’</div><div class="qm locked">M4ğŸ”’</div>
        <div class="qm">M5</div><div class="qm">M6</div><div class="qm">M7</div>
      </div>
    </div>
    <div class="worker-row"><div class="w-dot w-busy"></div><span style="flex:1;font-weight:500">Worker 1</span><span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted)">processing M3</span></div>
    <div class="worker-row"><div class="w-dot w-busy"></div><span style="flex:1;font-weight:500">Worker 2</span><span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted)">processing M4</span></div>
    <div class="worker-row"><div class="w-dot w-idle"></div><span style="flex:1;font-weight:500">Worker 3</span><span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--green)">idle â€” will pick M5</span></div>
    <div style="margin-top:.6rem;font-size:.75rem;color:var(--muted);line-height:1.6">
      â†‘ Burst of 10,000 messages? Workers drain at their own sustainable pace. Queue absorbs the spike.<br>
      <span style="color:var(--accent)">Service Bus</span>: sessions, DLQ, ordering &nbsp;Â·&nbsp;
      <span style="color:var(--yellow)">Storage Queue</span>: simpler, cheaper, no ordering
    </div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPIC VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('topicViz'); if (!c) return;
  const style = document.createElement('style');
  style.textContent = '@keyframes subpkt{0%{left:0;opacity:0}10%{opacity:1}90%{opacity:1}100%{left:28px;opacity:0}}';
  document.head.appendChild(style);
  const subs = [
    { name: 'Inventory Service',   filter: 'Subject = "order.placed"', d: '0s' },
    { name: 'Email Service',       filter: 'Amount > 0',               d: '.3s' },
    { name: 'Fraud Detection',     filter: 'Country = "NG"',           d: '.6s' },
    { name: 'Analytics Pipeline',  filter: '(all events)',             d: '.9s' },
  ];
  c.innerHTML = `
    <div class="topic-box">ğŸ“¤ Topic: <strong>orders</strong> &nbsp;Â·&nbsp; <span style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted)">1 published â†’ ${subs.length} copies created</span></div>
    ${subs.map(s => `
      <div class="sub-row">
        <div class="sub-line"><div class="sub-pkt" style="animation:subpkt 1.4s linear infinite ${s.d}"></div></div>
        <span class="sub-name">${s.name}</span>
        <span class="sub-filter">${s.filter}</span>
        <span class="fan-badge">SUB</span>
      </div>
    `).join('')}
    <div style="margin-top:.6rem;font-size:.75rem;color:var(--muted)">Adding a 5th subscriber requires <strong style="color:var(--text)">zero changes</strong> to the publisher.</div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PEEK-LOCK VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('peeklockViz'); if (!c) return;
  c.innerHTML = `
    <div class="pl-step"><div class="pl-icon">ğŸ“¥</div><div class="pl-text">Message received by Worker</div><div class="pl-badge pb-lock">LOCKED</div></div>
    <div class="pl-step warn"><div class="pl-icon">âš™ï¸</div><div class="pl-text">Worker processesâ€¦ lock TTL: 30s</div><div class="pl-badge pb-lock">IN-FLIGHT</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem;margin:.35rem 0">
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--green);margin-bottom:.28rem">âœ“ SUCCESS PATH</div>
        <div class="pl-step success"><div class="pl-icon">âœ…</div><div class="pl-text">Complete() called</div><div class="pl-badge pb-ok">DELETED</div></div>
      </div>
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--red);margin-bottom:.28rem">âœ• FAILURE PATH</div>
        <div class="pl-step danger"><div class="pl-icon">ğŸ’¥</div><div class="pl-text">Worker crashes</div><div class="pl-badge pb-fail">RE-QUEUED</div></div>
      </div>
    </div>
    <div class="pl-step danger"><div class="pl-icon">â˜ ï¸</div><div class="pl-text">MaxDeliveryCount exceeded (10 attempts)</div><div class="pl-badge pb-dlq">â†’ DLQ</div></div>
    <div style="margin-top:.55rem;background:rgba(248,113,113,.05);border:1px solid rgba(248,113,113,.18);border-radius:6px;padding:.55rem .85rem;font-size:.76rem;color:var(--muted)">
      <strong style="color:var(--red)">Dead Letter Queue</strong>: quarantines poison messages automatically.
      The DLQ does <em>not</em> alert you â€” you must set Azure Monitor alerts on DLQ depth. An unmonitored DLQ is a silent data black hole.
    </div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSIONS VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('sessionsViz'); if (!c) return;
  function lane(sClass, id, steps, worker, rgb) {
    const msgs = steps.map(s =>
      `<div class="smsg" style="background:rgba(${rgb},.1);border-color:var(${sClass==='s-cyan'?'--accent':sClass==='s-purple'?'--purple':'--green'})">${s}</div>`
    ).join('');
    return `<div class="sess-lane">
      <div class="sess-id ${sClass}">${id}</div>
      <div class="sess-msgs">${msgs}</div>
      <span style="font-size:.6rem;color:var(--muted)">â†’</span>
      <span class="sess-worker">${worker}</span>
    </div>`;
  }
  c.innerHTML = `
    ${lane('s-cyan',   'loan-APP-42', ['S1','S2','S3','S4'], 'Worker 1', '56,189,248')}
    ${lane('s-purple', 'loan-APP-17', ['S1','S2','S3'],      'Worker 2', '167,139,250')}
    ${lane('s-green',  'loan-APP-91', ['S1','S2'],           'Worker 3', '74,222,128')}
    <div style="margin-top:.5rem;background:rgba(248,113,113,.05);border:1px solid rgba(248,113,113,.2);border-radius:6px;padding:.55rem .8rem;font-size:.75rem;color:var(--muted)">
      <strong style="color:var(--red)">Without sessions:</strong> Worker 2 might process APP-42/Step3 before Step1 is done. Credit score runs before validation. Workflow corrupted.
    </div>
    <div style="margin-top:.5rem;font-size:.74rem;color:var(--muted)">Each session = isolated ordered channel. Scale horizontally <em>across</em> sessions.</div>
  `;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSACTION VIZ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('txViz'); if (!c) return;
  c.innerHTML = `
    <div class="tx-ops" id="txOps">
      <div class="tx-op" id="to0"><div class="tx-op-lbl">RECEIVE</div><div class="tx-op-name">Transfer $100</div></div>
      <div class="tx-op" id="to1"><div class="tx-op-lbl">SEND</div><div class="tx-op-name">Debit Account A</div></div>
      <div class="tx-op" id="to2"><div class="tx-op-lbl">SEND</div><div class="tx-op-name">Credit Account B</div></div>
      <div class="tx-op" id="to3"><div class="tx-op-lbl">COMPLETE</div><div class="tx-op-name">Original msg</div></div>
    </div>
    <div class="tx-btns">
      <button class="tx-btn tb-c" onclick="txRun('commit')">â–¶ COMMIT</button>
      <button class="tx-btn tb-r" onclick="txRun('rollback')">â–¶ SIMULATE CRASH</button>
    </div>
    <div id="txResult"></div>
  `;
  window.txRun = function(mode) {
    [0,1,2,3].forEach(i => document.getElementById('to'+i).className = 'tx-op');
    document.getElementById('txResult').textContent = 'runningâ€¦';
    [0,1,2,3].forEach((_, i) => {
      setTimeout(() => {
        document.getElementById('to'+i).className = 'tx-op ' + (mode === 'commit' ? 'commit' : 'rollback');
      }, i * 230);
    });
    setTimeout(() => {
      const r = document.getElementById('txResult');
      r.textContent = mode === 'commit'
        ? 'âœ“ All 4 operations committed atomically. Money moved safely.'
        : 'âœ• Step 3 failed. All operations rolled back. Transfer msg returns to queue.';
      r.style.color = mode === 'commit' ? 'var(--green)' : 'var(--red)';
    }, 4 * 230 + 80);
  };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPARE TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('compareTable'); if (!c) return;
  const rows = [
    { svc: 'Service Bus',    use: 'Workflows, ordering, DLQ, sessions, transactions',  not: 'High-throughput streaming, event replay' },
    { svc: 'Storage Queue',  use: 'Simple async, huge backlog, low cost',              not: 'Sessions, ordering, DLQ, rich routing' },
    { svc: 'Event Hubs',     use: 'Telemetry, log ingestion, replay, Kafka compat',   not: 'Per-msg ACK, DLQ, sessions, workflows' },
    { svc: 'Kafka',          use: 'Event sourcing, infinite retention, cross-DC',      not: 'Managed simplicity, Azure-native integrations' },
    { svc: 'HTTP / REST',    use: 'Sync request-response, immediate feedback',        not: 'Decoupling, buffering, offline consumers' },
    { svc: 'DB Polling',     use: 'Simple workflow, existing DB, low volume',          not: 'Scale, fan-out, distributed consumers' },
  ];
  c.innerHTML = `<thead><tr><th>Primitive</th><th>Use When</th><th>Not When</th></tr></thead><tbody>
    ${rows.map(r => `<tr><td class="tsvc">${r.svc}</td><td>${r.use}</td><td style="color:var(--red)">${r.not}</td></tr>`).join('')}
  </tbody>`;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = document.getElementById('notGrid'); if (!c) return;
  const items = [
    { title: 'Not a Database',        body: 'Messages vanish after acknowledgement. No queries, no updates, no long-lived state. Use a DB for state; use Service Bus for events.' },
    { title: 'Not a Task Scheduler',  body: 'Scheduled triggers belong to Azure Functions timer bindings or Logic Apps. A message with a future enqueue time is a workaround.' },
    { title: 'Not Synchronous RPC',   body: 'Request-reply over a queue adds complexity with no benefit over HTTP when both parties are reliably online. Use messaging for asynchrony.' },
    { title: 'Not Exactly-Once',      body: 'At-least-once + idempotent consumers is the correct model. "The broker guarantees exactly-once" leads to double-processing bugs under failure.' },
  ];
  c.innerHTML = items.map(i => `
    <div class="not-card">
      <div class="not-title">${i.title}</div>
      <div class="not-body">${i.body}</div>
    </div>
  `).join('');
})();
</script>
</body>
</html>
